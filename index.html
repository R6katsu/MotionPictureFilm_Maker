<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Motion Picture Film Maker</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    .filmstrip-wrapper {
        display: flex;
        overflow: hidden;
        width: 300px;
        margin: 0 auto;
        border-top: 20px solid #444;
        border-bottom: 20px solid #444;
        background: #000;
    }
    .perforation {
        width: 20px;
        background: repeating-linear-gradient(
            to bottom,
            #333,
            #333 4px,
            #000 4px,
            #000 8px
        );
    }
    .filmstrip {
        display: flex;
        gap: 10px;
        padding: 20px 10px;
        background: #000;
    }
    .filmstrip img {
        height: 120px;
        border: 4px solid #fff;
        box-shadow: 0 0 5px #000;
    }
    #gif-output img { max-width: 100%; margin-top: 20px; }
</style>
</head>
<body>
<h1>Motion Picture Film Maker</h1>
<p>画像を選択・追加してフィルム風のスライドショーを作成し、GIFとしてダウンロードできます。</p>
<input type="file" id="image-upload" accept="image/*" multiple>
<button id="generate-gif" disabled>GIF生成</button>
<div class="filmstrip-wrapper" id="filmstrip-wrapper">
    <div class="perforation"></div>
    <div class="filmstrip" id="filmstrip"></div>
    <div class="perforation"></div>
</div>
<div id="gif-output"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const imageInput = document.getElementById('image-upload');
const filmstrip = document.getElementById('filmstrip');
const generateBtn = document.getElementById('generate-gif');
let imageUrls = [];

imageInput.addEventListener('change', (e) => {
    Array.from(e.target.files).forEach(file => {
        const url = URL.createObjectURL(file);
        imageUrls.push(url);
        const img = document.createElement('img');
        img.src = url;
        filmstrip.appendChild(img);
    });
    generateBtn.disabled = imageUrls.length === 0;
    imageInput.value = '';
});

generateBtn.addEventListener('click', async () => {
    if (imageUrls.length === 0) return;
    generateBtn.disabled = true;

    const wrapper = document.createElement('div');
    wrapper.className = 'filmstrip-wrapper';
    const left = document.createElement('div');
    left.className = 'perforation';
    const strip = document.createElement('div');
    strip.className = 'filmstrip';
    const right = document.createElement('div');
    right.className = 'perforation';
    wrapper.appendChild(left);
    wrapper.appendChild(strip);
    wrapper.appendChild(right);
    imageUrls.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        strip.appendChild(img);
    });
    wrapper.style.position = 'fixed';
    wrapper.style.left = '-9999px';
    document.body.appendChild(wrapper);

    const frameWidth = wrapper.clientWidth;
    const perfWidth = left.clientWidth;
    const visibleWidth = frameWidth - perfWidth * 2;
    const maxOffset = strip.scrollWidth - visibleWidth;
    const step = 10;
    const frames = [];
    for (let offset = 0; offset <= maxOffset; offset += step) {
        strip.style.transform = `translateX(-${offset}px)`;
        const canvas = await html2canvas(wrapper);
        frames.push(canvas.toDataURL('image/png'));
    }
    document.body.removeChild(wrapper);

    gifshot.createGIF({
        images: frames,
        gifWidth: frameWidth,
        gifHeight: wrapper.clientHeight,
        interval: 0.1
    }, function(obj) {
        generateBtn.disabled = false;
        if(!obj.error) {
            const image = obj.image;
            const animatedImage = document.createElement('img');
            animatedImage.src = image;
            const downloadLink = document.createElement('a');
            downloadLink.href = image;
            downloadLink.download = 'filmstrip.gif';
            downloadLink.textContent = 'GIFをダウンロード';

            const output = document.getElementById('gif-output');
            output.innerHTML = '';
            const gifWrapper = document.createElement('div');
            gifWrapper.className = 'filmstrip-wrapper';
            const gifLeft = document.createElement('div');
            gifLeft.className = 'perforation';
            const gifStrip = document.createElement('div');
            gifStrip.className = 'filmstrip';
            gifStrip.appendChild(animatedImage);
            const gifRight = document.createElement('div');
            gifRight.className = 'perforation';
            gifWrapper.appendChild(gifLeft);
            gifWrapper.appendChild(gifStrip);
            gifWrapper.appendChild(gifRight);
            output.appendChild(gifWrapper);
            output.appendChild(document.createElement('br'));
            output.appendChild(downloadLink);
        }
    });
});
</script>
</body>
</html>
