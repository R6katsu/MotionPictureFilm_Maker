<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Motion Picture Film Maker</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    .film-container {
        display: flex;
        justify-content: center;
        align-items: stretch;
        width: 340px;
        margin: auto;
    }
    .sprocket {
        width: 20px;
        background: repeating-linear-gradient(
            to bottom,
            #333,
            #333 4px,
            #000 4px,
            #000 8px
        );
    }
    .filmstrip {
        display: flex;
        gap: 10px;
        padding: 20px 10px;
        background:#000;
        border-top: 20px solid #444;
        border-bottom: 20px solid #444;
        overflow: hidden;
        width: 300px;
    }
    .filmstrip img {
        height: 120px;
        border: 4px solid #fff;
        box-shadow: 0 0 5px #000;
    }
    #gif-output img { max-width: 100%; margin-top: 20px; }
</style>
</head>
<body>
<h1>Motion Picture Film Maker</h1>
<p>画像を選択・追加してフィルム風のスライドショーを作成し、GIFとしてダウンロードできます。</p>
<input type="file" id="image-upload" accept="image/*" multiple>
<button id="generate-gif" disabled>GIF生成</button>
<div class="film-container">
    <div class="sprocket"></div>
    <div class="filmstrip" id="filmstrip"></div>
    <div class="sprocket"></div>
</div>
<div id="gif-output"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const imageInput = document.getElementById('image-upload');
const filmContainer = document.querySelector('.film-container');
const filmstrip = document.getElementById('filmstrip');
const generateBtn = document.getElementById('generate-gif');
let imageUrls = [];

function applyFilmGrain(canvas) {
    const ctx = canvas.getContext('2d');
    const { width, height } = canvas;
    const imgData = ctx.getImageData(0, 0, width, height);
    const data = imgData.data;
    for (let i = 0; i < data.length; i += 4) {
        const grain = (Math.random() - 0.5) * 30;
        data[i] = Math.max(0, Math.min(255, data[i] + grain));
        data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + grain));
        data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + grain));
    }
    ctx.putImageData(imgData, 0, 0);
}

imageInput.addEventListener('change', (e) => {
    Array.from(e.target.files).forEach(file => {
        const url = URL.createObjectURL(file);
        imageUrls.push(url);
        const img = document.createElement('img');
        img.src = url;
        filmstrip.appendChild(img);
    });
    generateBtn.disabled = imageUrls.length === 0;
    imageInput.value = '';
});

generateBtn.addEventListener('click', async () => {
    if (imageUrls.length === 0) return;
    generateBtn.disabled = true;
    const frames = [];
    const step = 20;
    const total = filmstrip.scrollWidth - filmstrip.clientWidth;
    filmstrip.scrollLeft = 0;
    for(let pos = 0; pos <= total; pos += step) {
        filmstrip.scrollLeft = pos;
        await new Promise(r => setTimeout(r, 50));
        const canvas = await html2canvas(filmContainer, {useCORS: true});
        applyFilmGrain(canvas);
        frames.push(canvas.toDataURL('image/png'));
    }
    gifshot.createGIF({
        images: frames,
        gifWidth: filmContainer.clientWidth,
        gifHeight: filmContainer.clientHeight,
        interval: 0.2
    }, function(obj) {
        generateBtn.disabled = false;
        if(!obj.error) {
            const image = obj.image;
            const animatedImage = document.createElement('img');
            animatedImage.src = image;
            const downloadLink = document.createElement('a');
            downloadLink.href = image;
            downloadLink.download = 'film.gif';
            downloadLink.textContent = 'GIFをダウンロード';

            const output = document.getElementById('gif-output');
            output.innerHTML = '';
            const gifContainer = document.createElement('div');
            gifContainer.className = 'film-container';
            gifContainer.innerHTML = `
                <div class="sprocket"></div>
                <div class="filmstrip"></div>
                <div class="sprocket"></div>
            `;
            gifContainer.querySelector('.filmstrip').appendChild(animatedImage);
            output.appendChild(gifContainer);
            output.appendChild(document.createElement('br'));
            output.appendChild(downloadLink);
        }
    });
});
</script>
</body>
</html>
